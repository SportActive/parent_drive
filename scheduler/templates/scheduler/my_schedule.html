{% load static %}
<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú—ñ–π –∫–∞–±—ñ–Ω–µ—Ç</title>
    <link rel="icon" href="{% static 'scheduler/favicon.png' %}" type="image/png">
    <style>
        body { font-family: sans-serif; background-color: #f8f9fa; margin: 0; }
        .header {
            background: #fff;
            padding: 10px 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo a {
            display: flex;
            align-items: center;
            font-weight: bold;
            color: #333;
            text-decoration: none;
            font-size: 20px;
        }
        .logo img {
            height: 40px;
            margin-right: 10px;
        }
        .nav-links {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .nav-links a { color: #333; text-decoration: none; }
        .container { max-width: 900px; margin: 2em auto; padding: 1em 2em; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .holiday-event { background-color: #dc3545 !important; border-color: #dc3545 !important; }
        #context-menu { position: absolute; background: white; border: 1px solid #ccc; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); padding: 5px 0; min-width: 220px; z-index: 1000; display: none; border-radius: 5px; }
        #context-menu ul { list-style: none; padding: 0; margin: 0; }
        #context-menu ul li { padding: 8px 15px; cursor: pointer; }
        #context-menu ul li:hover { background: #f4f4f4; }
        #context-menu ul li.separator { border-top: 1px solid #eee; margin-top: 5px; padding-top: 5px; }
    </style>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
</head>
<body>

    <header class="header">
        <div class="logo">
            <a href="{% url 'schedule' %}">
                <img src="{% static 'scheduler/logo.png' %}" alt="–õ–æ–≥–æ—Ç–∏–ø KinderRides">
                KinderRides
            </a>
        </div>
        <div class="nav-links">
            <a href="{% url 'schedule' %}">&larr; –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è</a>
            {% if user.is_staff %}
                <a href="{% url 'statistics' %}"><strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</strong></a>
                <a href="{% url 'manage_users' %}"><strong>–ö–µ—Ä—É–≤–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏</strong></a>
            {% endif %}
        </div>
    </header>

    <div class="container">
        <h1>–ú—ñ–π –≥—Ä–∞—Ñ—ñ–∫</h1>
        <p>–ö–ª—ñ–∫–Ω—ñ—Ç—å –Ω–∞ –±—É–¥—å-—è–∫–∏–π –¥–µ–Ω—å –∞–±–æ –ø–æ–¥—ñ—é, —â–æ–± –≤—ñ–¥–∫—Ä–∏—Ç–∏ –º–µ–Ω—é –¥—ñ–π.</p>
        <div id='my-calendar' data-is-admin="{{ is_admin }}"></div>
    </div>

    <div id="context-menu">
      <ul id="context-menu-items"></ul>
    </div>

    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('my-calendar');
            const isAdmin = calendarEl.dataset.isAdmin === 'True';
            const isAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};
            
            const contextMenu = document.getElementById('context-menu');
            const menuItems = document.getElementById('context-menu-items');

            function showContextMenu(x, y, items) {
                if (items.length === 0) return;
                menuItems.innerHTML = '';
                items.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item.label;
                    if (item.className) li.className = item.className;
                    li.addEventListener('click', () => {
                        item.action();
                        contextMenu.style.display = 'none';
                    });
                    menuItems.appendChild(li);
                });
                contextMenu.style.left = x + 'px';
                contextMenu.style.top = y + 'px';
                contextMenu.style.display = 'block';
            }

            window.addEventListener('click', () => contextMenu.style.display = 'none');

            var calendar = new FullCalendar.Calendar(calendarEl, {
                height: 'auto',
                initialView: 'dayGridMonth',
                locale: 'uk',
                firstDay: 1, // üëà –û—Å—å —Ü—è –∑–º—ñ–Ω–∞ (1 = –ü–æ–Ω–µ–¥—ñ–ª–æ–∫)
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth' },
                events: "{% url 'unavailability_events' %}",
                
                dateClick: function(info) {
                    info.jsEvent.stopPropagation();
                    contextMenu.style.display = 'none';
                    const items = [];
                    if (isAuthenticated) {
                         items.push({ label: '–Ø –∑–∞–π–Ω—è—Ç–∏–π / –Ø –≤—ñ–ª—å–Ω–∏–π', action: () => {
                            fetch("{% url 'update_unavailability' %}", { method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken}, body: JSON.stringify({ start_date: info.dateStr }) }).then(() => calendar.refetchEvents());
                        }});
                    }
                    if (isAdmin) {
                        items.push({ label: '–ó—Ä–æ–±–∏—Ç–∏ –≤–∏—Ö—ñ–¥–Ω–∏–º / —Ä–æ–±–æ—á–∏–º', className: 'separator', action: () => {
                             fetch("{% url 'toggle_holiday' %}", { method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken}, body: JSON.stringify({ date: info.dateStr }) }).then(() => calendar.refetchEvents());
                        }});
                        items.push({ label: '–ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏ —á–µ—Ä–≥—É–≤–∞–Ω–Ω—è...', action: () => {
                            fetch("{% url 'get_parents_list' %}")
                                .then(res => res.json())
                                .then(parents => {
                                    let promptText = "–í–∏–±–µ—Ä—ñ—Ç—å –≤–æ–¥—ñ—è:\n";
                                    parents.forEach((p, i) => promptText += `${i + 1}: ${p.name}\n`);
                                    const choice = parseInt(prompt(promptText)) - 1;
                                    if (!isNaN(choice) && parents[choice]) {
                                        fetch("{% url 'admin_assign_driver' %}", { method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken}, body: JSON.stringify({ date: info.dateStr, parent_id: parents[choice].id }) }).then(() => calendar.refetchEvents());
                                    }
                                });
                        }});
                    }
                    showContextMenu(info.jsEvent.pageX, info.jsEvent.pageY, items);
                },
                
                eventClick: function(info) {
                    info.jsEvent.stopPropagation();
                    contextMenu.style.display = 'none';
                    const props = info.event.extendedProps;
                    const eventId = info.event.id;
                    const items = [];

                    if (props.is_mine && eventId.startsWith('drive_') && !props.is_swap_requested) {
                        items.push({ label: '–ü–æ–ø—Ä–æ—Å–∏—Ç–∏ –ø—Ä–æ –∑–∞–º—ñ–Ω—É', action: () => {
                            const driveId = eventId.replace('drive_', '');
                            fetch(`/swap/${driveId}/`, { method: 'POST', headers: { 'X-CSRFToken': csrftoken } }).then(() => calendar.refetchEvents());
                        }});
                    }
                    
                    if (isAdmin && eventId.startsWith('drive_')) {
                        items.push({ label: '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –≤ –∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—ñ', className: 'separator', action: () => {
                             window.open(props.admin_url, '_blank');
                        }});
                    }
                    
                    showContextMenu(info.jsEvent.pageX, info.jsEvent.pageY, items);
                }
            });
            calendar.render();
        });
    </script>
</body>
</html>