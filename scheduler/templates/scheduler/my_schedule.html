{% load static %}
<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мій кабінет</title>
    <link rel="icon" href="{% static 'scheduler/favicon.png' %}" type="image/png">
    <style>
        body { font-family: sans-serif; background-color: #f8f9fa; margin: 0; }
        .header {
            background: #fff;
            padding: 10px 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo a {
            display: flex;
            align-items: center;
            font-weight: bold;
            color: #333;
            text-decoration: none;
            font-size: 20px;
        }
        .logo img {
            height: 40px;
            margin-right: 10px;
        }
        .nav-links {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .nav-links a { color: #333; text-decoration: none; }
        .container { max-width: 900px; margin: 2em auto; padding: 1em 2em; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1, .legend, h2 { color: #333; }
        #my-calendar { margin-top: 2em; }
        .legend span { display: inline-block; width: 15px; height: 15px; margin-right: 5px; vertical-align: middle; }
        .admin-actions { margin-top: 2em; padding-top: 1.5em; border-top: 1px solid #eee; }
        .recalculate-btn { background-color: #17a2b8; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        .recalculate-btn:hover { background-color: #138496; }
        #context-menu { position: absolute; background: white; border: 1px solid #ccc; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); padding: 5px 0; min-width: 220px; z-index: 1000; display: none; border-radius: 5px; }
        #context-menu ul { list-style: none; padding: 0; margin: 0; }
        #context-menu ul li { padding: 8px 15px; cursor: pointer; }
        #context-menu ul li:hover { background: #f4f4f4; }
        #context-menu ul li.separator { border-top: 1px solid #eee; margin-top: 5px; padding-top: 5px; }
    </style>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
</head>
<body>

    <header class="header">
        <div class="logo">
            <a href="{% url 'schedule' %}">
                <img src="{% static 'scheduler/logo.png' %}" alt="Логотип KinderRides">
                KinderRides
            </a>
        </div>
        <div class="nav-links">
            <a href="{% url 'schedule' %}">&larr; Повернутися до календаря</a>
            {% if user.is_staff %}
                <a href="{% url 'statistics' %}"><strong>Статистика</strong></a>
                <a href="{% url 'manage_users' %}"><strong>Керування користувачами</strong></a>
            {% endif %}
        </div>
    </header>

    <div class="container">
        <h1>Мій графік</h1>
        <p>Клікніть на будь-який день або подію, щоб відкрити меню дій.</p>
        <div class="legend">
             <span style="background-color: #28a745;"></span> Моє чергування &nbsp;
             <span style="background-color: #007bff;"></span> Чуже чергування &nbsp;
             <span style="background-color: #dc3545;"></span> Моя недоступність &nbsp;
             <span style="background-color: #6c757d;"></span> Чужа недоступність / Заміна
        </div>
        <div id='my-calendar' data-is-admin="{{ is_admin }}"></div>
        {% if user.is_staff %}
        <div class="admin-actions">
            <h2>Дії Адміністратора</h2>
            <p>Ця дія видалить усі чергування, що починаються через 7 днів від сьогодні, і згенерує новий, справедливий графік до кінця навчального року.</p>
            <button id="recalculate-btn" class="recalculate-btn">Перерахувати майбутній розклад</button>
        </div>
        {% endif %}
    </div>

    <div id="context-menu">
      <ul id="context-menu-items"></ul>
    </div>

    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('my-calendar');
            const isAdmin = calendarEl.dataset.isAdmin === 'True';
            const isAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};
            
            const contextMenu = document.getElementById('context-menu');
            const menuItems = document.getElementById('context-menu-items');

            function showContextMenu(x, y, items) {
                if (items.length === 0) return;
                menuItems.innerHTML = '';
                items.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item.label;
                    if (item.className) li.className = item.className;
                    li.addEventListener('click', () => {
                        item.action();
                        contextMenu.style.display = 'none';
                    });
                    menuItems.appendChild(li);
                });
                contextMenu.style.left = x + 'px';
                contextMenu.style.top = y + 'px';
                contextMenu.style.display = 'block';
            }

            window.addEventListener('click', () => contextMenu.style.display = 'none');

            var calendar = new FullCalendar.Calendar(calendarEl, {
                height: 'auto',
                initialView: 'dayGridMonth',
                locale: 'uk',
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth' },
                events: "{% url 'unavailability_events' %}",
                
                dateClick: function(info) {
                    info.jsEvent.stopPropagation();
                    contextMenu.style.display = 'none';
                    const items = [];
                    if (isAuthenticated) {
                         items.push({ label: 'Я зайнятий / Я вільний', action: () => {
                            fetch("{% url 'update_unavailability' %}", { method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken}, body: JSON.stringify({ start_date: info.dateStr }) }).then(() => calendar.refetchEvents());
                        }});
                    }
                    if (isAdmin) {
                        items.push({ label: 'Зробити вихідним / робочим', className: 'separator', action: () => {
                             fetch("{% url 'toggle_holiday' %}", { method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken}, body: JSON.stringify({ date: info.dateStr }) }).then(() => calendar.refetchEvents());
                        }});
                        items.push({ label: 'Призначити чергування...', action: () => {
                            fetch("{% url 'get_parents_list' %}")
                                .then(res => res.json())
                                .then(parents => {
                                    let promptText = "Виберіть водія:\n";
                                    parents.forEach((p, i) => promptText += `${i + 1}: ${p.name}\n`);
                                    const choice = parseInt(prompt(promptText)) - 1;
                                    if (!isNaN(choice) && parents[choice]) {
                                        fetch("{% url 'admin_assign_driver' %}", { method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken}, body: JSON.stringify({ date: info.dateStr, parent_id: parents[choice].id }) }).then(() => calendar.refetchEvents());
                                    }
                                });
                        }});
                    }
                    showContextMenu(info.jsEvent.pageX, info.jsEvent.pageY, items);
                },
                
                eventClick: function(info) {
                    info.jsEvent.stopPropagation();
                    contextMenu.style.display = 'none';
                    const props = info.event.extendedProps;
                    const eventId = info.event.id;
                    const items = [];

                    if (props.is_mine && eventId.startsWith('drive_') && !props.is_swap_requested) {
                        items.push({ label: 'Попросити про заміну', action: () => {
                            const driveId = eventId.replace('drive_', '');
                            fetch(`/swap/${driveId}/`, { method: 'POST', headers: { 'X-CSRFToken': csrftoken } }).then(() => calendar.refetchEvents());
                        }});
                    }
                    
                    if (isAdmin && eventId.startsWith('drive_')) {
                        items.push({ label: 'Редагувати в адмін-панелі', className: 'separator', action: () => {
                             window.open(props.admin_url, '_blank');
                        }});
                    }
                    
                    showContextMenu(info.jsEvent.pageX, info.jsEvent.pageY, items);
                }
            });
            calendar.render();

            const recalcBtn = document.getElementById('recalculate-btn');
            if (recalcBtn) {
                recalcBtn.addEventListener('click', function() {
                    if (confirm('Ви впевнені? Ця дія незворотна.')) {
                        fetch("{% url 'recalculate_schedule' %}", {
                            method: 'POST',
                            headers: { 'X-CSRFToken': csrftoken }
                        })
                        .then(response => response.json())
                        .then(data => {
                            alert(data.message || 'Сталася помилка.');
                            calendar.refetchEvents();
                        });
                    }
                });
            }
        });
    </script>
</body>
</html>